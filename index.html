<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Latmasken ‚Äì AI Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b; --brand:#2563eb; --ring:#93c5fd; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e5e7eb}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .worm{width:28px;height:28px;border-radius:20px;background:linear-gradient(90deg,#a7f3d0,#fde68a,#fecaca);box-shadow:inset 0 0 0 2px #00000010}
    .title{font-weight:800;letter-spacing:.2px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    nav button{appearance:none;border:1px solid #e5e7eb;background:#fff;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    nav button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px #00000010;border:1px solid #e5e7eb}
    .card .pad{padding:16px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#f1f5f9;border:1px solid #e2e8f0;padding:8px 10px;border-radius:999px}
    .muted{color:var(--muted)} .hidden{display:none} .spacer{height:12px}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#eef2ff;color:#1e3a8a}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font:inherit}
    input:focus,select:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .preview{max-width:100%;border-radius:10px;border:1px dashed #cbd5e1}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
  </style>
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.webmanifest" />
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="worm" aria-hidden="true"></div>
        <div>
          <div class="title">Latmasken</div>
          <div class="muted" style="font-size:12px">Fotografera din mat ‚Ä¢ F√• pepp ‚Ä¢ F√∂lj din vikt</div>
        </div>
      </div>
      <nav id="tabs">
        <button data-tab="hem">Hem</button>
        <button data-tab="kamera" class="active">Kamera</button>
        <button data-tab="vikt">Vikt</button>
        <button data-tab="medaljer">Medaljer</button>
        <button data-tab="coach">Coach</button>
        <button data-tab="konto" style="margin-left:auto">Konto</button>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:16px">
    <!-- HEM -->
    <section id="view-hem" class="grid hidden">
      <div class="card"><div class="pad">
        <h2>Idag</h2>
        <div class="pill"><strong id="todayKcal">0</strong><span class="muted">&nbsp;kcal av&nbsp;</span><strong id="goalKcal">1800</strong><span class="muted">&nbsp;kcal</span></div>
        <div class="spacer"></div>
        <div id="coachBubble" class="card" style="border-radius:12px;background:#f8fafc;border:1px solid #e2e8f0"><div class="pad">
          <strong>Latmasken s√§ger:</strong>
          <div id="coachMsg" class="muted">Hej! S√§tt ett m√•l i Konto och fota din f√∂rsta m√•ltid via Kamera üêõ</div>
        </div></div>
        <div class="spacer"></div>
        <div id="foodList" class="muted">Inget loggat √§nnu.</div>
      </div></div>
    </section>

    <!-- KAMERA -->
    <section id="view-kamera" class="grid">
      <div class="card"><div class="pad">
        <h2>Fota din mat</h2>
        <p class="muted">Ladda upp ett foto. AI gissar matr√§tt och vi h√§mtar n√§ring fr√•n USDA. Fyll g√§rna i manuellt om n√•got ser fel ut.</p>
        <div class="muted" style="font-size:12px">Kr√§ver <code>OPENAI_API_KEY</code> och <code>USDA_API_KEY</code> i Vercel.</div>
        <div class="spacer"></div>
        <input type="file" id="photoInput" accept="image/*" capture="environment" />
        <div class="spacer"></div>
        <img id="photoPreview" class="preview hidden" alt="F√∂rhandsvisning" />
        <div class="spacer"></div>
        <div class="row" style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="foodName" placeholder="Matr√§tt" />
          <input id="foodKcal" type="number" placeholder="kcal" />
          <input id="foodFat" type="number" placeholder="Fett (g)" />
          <input id="foodProtein" type="number" placeholder="Protein (g)" />
          <input id="foodCarbs" type="number" placeholder="Kolhydrater (g)" />
          <button class="btn" id="analyzeBtn">Analysera (AI)</button>
          <button class="btn secondary" id="saveMealBtn">Spara</button>
        </div>
        <div class="spacer"></div>
        <div class="muted" id="analyzeStatus"></div>
      </div></div>

      <div class="card"><div class="pad">
        <h3>Senaste m√•ltider</h3>
        <div id="recentMeals" class="muted">‚Äî</div>
      </div></div>
    </section>

    <!-- VIKT -->
    <section id="view-vikt" class="hidden grid">
      <div class="card"><div class="pad">
        <h2>Viktkurva</h2>
        <canvas id="weightChart" height="220"></canvas>
        <div class="spacer"></div>
        <div class="row" style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="weightInput" type="number" step="0.1" placeholder="Dagens vikt (kg)" />
          <button class="btn" id="addWeightBtn">L√§gg till</button>
          <button class="btn secondary" id="resetWeightBtn">Rensa (demo)</button>
        </div>
      </div></div>

      <div class="card"><div class="pad">
        <h3>M√•l</h3>
        <div class="row" style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="goalKcalInput" type="number" placeholder="Dagligt m√•l (kcal)" />
          <input id="goalWeightInput" type="number" step="0.1" placeholder="M√•lvikt (kg)" />
          <button class="btn" id="saveGoalsBtn">Spara m√•l</button>
        </div>
      </div></div>
    </section>

    <!-- √ñVRIGT -->
    <section id="view-medaljer" class="hidden grid"><div class="card"><div class="pad"><h2>Medaljer</h2><div class="muted">üèÖ F√∂rsta inloggningen ¬∑ üèÖ F√∂rsta m√•ltiden ¬∑ üèÖ 3 dagar i rad</div></div></div></section>
    <section id="view-coach" class="hidden grid"><div class="card"><div class="pad"><h2>Latmasken coach</h2><div id="coachOutput" class="muted">Regelbaserad demo ‚Äì GPT kopplas in senare.</div><div class="spacer"></div><button class="btn" id="refreshCoach">Uppdatera coach</button></div></div></section>
    <section id="view-konto" class="hidden grid"><div class="card"><div class="pad"><h2>Konto</h2><div class="row" style="display:flex;gap:10px;flex-wrap:wrap"><input id="emailInput" type="email" placeholder="E-post (lokalt)" /><button class="btn" id="saveEmailBtn">Spara</button></div><p class="muted">Allt sparas lokalt (localStorage).</p></div></div></section>
  
  <!-- Installationsbanner (PWA) -->
  <div id="installBanner" class="card hidden" style="position:fixed;left:16px;right:16px;bottom:16px;z-index:999;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px #00000022">
    <div class="pad" style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div class="row" style="display:flex;gap:12px;align-items:center">
        <div class="worm" aria-hidden="true"></div>
        <div><strong>Installera Latmasken?</strong><div class="muted" style="font-size:12px">L√§gg till p√• hemsk√§rmen f√∂r app-k√§nsla</div></div>
      </div>
      <div class="row" style="display:flex;gap:8px"><button id="installBtn" class="btn">Installera</button><button id="installClose" class="btn secondary">Inte nu</button></div>
    </div>
  </div>

  <footer><div class="muted" style="text-align:center;padding:24px">Latmasken ‚Ä¢ AI Demo ‚Ä¢ ¬© 2025</div></footer>

<script>
// ======= LOKAL LAGRING =======
const DB = {
  get email(){ return localStorage.getItem('email') || '' },
  set email(v){ localStorage.setItem('email', v) },
  get goalKcal(){ return +(localStorage.getItem('goalKcal')||1800) },
  set goalKcal(v){ localStorage.setItem('goalKcal', v) },
  get goalWeight(){ return +(localStorage.getItem('goalWeight')||0) },
  set goalWeight(v){ localStorage.setItem('goalWeight', v) },
  get meals(){ return JSON.parse(localStorage.getItem('meals')||'[]') },
  set meals(arr){ localStorage.setItem('meals', JSON.stringify(arr)) },
  get weights(){ return JSON.parse(localStorage.getItem('weights')||'[]') },
  set weights(arr){ localStorage.setItem('weights', JSON.stringify(arr)) },
  reset(){ localStorage.clear() }
}

// ======= NAVIGATION =======
const tabs = document.querySelectorAll('#tabs button');
const views = { hem:document.getElementById('view-hem'), kamera:document.getElementById('view-kamera'), vikt:document.getElementById('view-vikt'), medaljer:document.getElementById('view-medaljer'), coach:document.getElementById('view-coach'), konto:document.getElementById('view-konto') }
tabs.forEach(btn=>btn.addEventListener('click',()=>{
  tabs.forEach(b=>b.classList.remove('active')); btn.classList.add('active')
  const target = btn.dataset.tab
  Object.entries(views).forEach(([k,el])=> el.classList.toggle('hidden', k!==target))
  if(target==='vikt') renderChart(); if(target==='hem'||target==='coach') updateCoach(); if(target==='hem') renderHome(); if(target==='kamera') renderMeals()
}))

// ======= HEM =======
const todayKcalEl = document.getElementById('todayKcal'); const goalKcalEl = document.getElementById('goalKcal'); const foodListEl = document.getElementById('foodList')
function kcalToday(){ const today=new Date().toISOString().slice(0,10); return DB.meals.filter(m=>m.date.startsWith(today)).reduce((s,m)=>s+Number(m.calories||0),0) }
function renderHome(){
  goalKcalEl.textContent=DB.goalKcal; todayKcalEl.textContent=kcalToday();
  const t=new Date().toISOString().slice(0,10); const items=DB.meals.filter(m=>m.date.startsWith(t));
  foodListEl.innerHTML = items.length ? items.map(m=>`${m.time} ‚Äì <strong>${m.name}</strong> ‚Äì <strong>${m.calories}</strong> kcal <span class="muted">(Fett ${m.fat}g ‚Ä¢ Protein ${m.protein}g ‚Ä¢ Kolh ${m.carbs}g)</span>`).join('<br>') : 'Inget loggat √§nnu.'
}

// ======= KAMERA / M√ÖLTIDER =======
const photoInput=document.getElementById('photoInput'), photoPreview=document.getElementById('photoPreview'), foodName=document.getElementById('foodName'), foodKcal=document.getElementById('foodKcal'), foodFat=document.getElementById('foodFat'), foodProtein=document.getElementById('foodProtein'), foodCarbs=document.getElementById('foodCarbs'), analyzeBtn=document.getElementById('analyzeBtn'), saveMealBtn=document.getElementById('saveMealBtn'), recentMeals=document.getElementById('recentMeals'), analyzeStatus=document.getElementById('analyzeStatus')
let lastImageBase64 = null
photoInput.addEventListener('change', async ev=>{
  const f=ev.target.files?.[0]; foodName.value=''; foodKcal.value=''; foodFat.value=''; foodProtein.value=''; foodCarbs.value=''; analyzeStatus.textContent=''
  if(!f){ photoPreview.classList.add('hidden'); lastImageBase64=null; return }
  const url=URL.createObjectURL(f); photoPreview.src=url; photoPreview.classList.remove('hidden')
  const b64 = await fileToBase64(f); lastImageBase64 = b64
})
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file) }) }

analyzeBtn.addEventListener('click', async ()=>{
  if(!lastImageBase64){ return toast('V√§lj en bild f√∂rst.') }
  analyzeBtn.disabled=true; const orig=analyzeBtn.textContent; analyzeBtn.textContent='Analyserar‚Ä¶'; analyzeStatus.textContent='AI analyserar bilden och h√§mtar n√§ring fr√•n USDA‚Ä¶'
  try{
    const r = await fetch('/api/analyze-food', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ imageBase64: lastImageBase64 }) })
    if(!r.ok){ throw new Error('API-svar '+r.status) }
    const data = await r.json()
    if(data && !data.error){
      foodName.value = data.name || ''
      foodKcal.value = Math.round(data.calories||0)
      foodFat.value = Math.round(data.fat||0)
      foodProtein.value = Math.round(data.protein||0)
      foodCarbs.value = Math.round(data.carbs||0)
      analyzeStatus.textContent = `AI: ${data.name} ‚Ä¢ ~${Math.round(data.calories)} kcal ‚Ä¢ ${Math.round(data.fat)}g fett ‚Ä¢ ${Math.round(data.protein)}g protein ‚Ä¢ ${Math.round(data.carbs)}g kolh.`
    } else {
      analyzeStatus.textContent = 'AI hittade inget s√§kert resultat ‚Äì fyll i f√§lten manuellt.'
    }
    saveMealBtn.focus()
  }catch(err){
    console.error(err); analyzeStatus.textContent = 'Kunde inte analysera bilden (kontrollera API-nycklar i Vercel). Du kan fylla i f√§lt manuellt.'
  }finally{
    analyzeBtn.disabled=false; analyzeBtn.textContent=orig
  }
})

saveMealBtn.addEventListener('click', ()=>{
  const name = foodName.value?.trim(); const calories = Number(foodKcal.value||0)
  const fat = Number(foodFat.value||0), protein = Number(foodProtein.value||0), carbs = Number(foodCarbs.value||0)
  if(!name || !calories){ return toast('Fyll i matr√§tt och kcal f√∂rst.') }
  const now = new Date(); const hh = String(now.getHours()).padStart(2,'0'); const mm = String(now.getMinutes()).padStart(2,'0')
  const items = DB.meals; items.push({ name, calories, fat, protein, carbs, time:`${hh}:${mm}`, date: now.toISOString() }); DB.meals = items
  foodName.value=''; foodKcal.value=''; foodFat.value=''; foodProtein.value=''; foodCarbs.value=''; photoInput.value=''; photoPreview.classList.add('hidden')
  renderMeals(); renderHome(); updateCoach();
  document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active')); document.querySelector('[data-tab="hem"]').classList.add('active'); Object.entries(views).forEach(([k,el])=> el.classList.toggle('hidden', k!=='hem'))
  toast('M√•ltid sparad!')
})
function renderMeals(){ const items=DB.meals.slice(-10).reverse(); recentMeals.innerHTML = items.length ? items.map(m=>`${new Date(m.date).toLocaleString('sv-SE')} ‚Äì <strong>${m.name}</strong> ‚Äì ${m.calories} kcal`).join('<br>') : '‚Äî' }

// ======= VIKT (mini-graf) =======
function renderChart(){ const canvas=document.getElementById('weightChart'); if(!canvas) return; const ctx=canvas.getContext('2d'); const data=DB.weights; ctx.clearRect(0,0,canvas.width,canvas.height); if(!data||data.length===0){ ctx.fillStyle='#94a3b8'; ctx.font='14px Inter,sans-serif'; ctx.fillText('L√§gg till din f√∂rsta vikt f√∂r att se grafen',10,24); return } const values=data.map(d=>Number(d.value)); const dpr=window.devicePixelRatio||1; canvas.width=canvas.clientWidth*dpr; canvas.height=canvas.clientHeight*dpr; ctx.scale(dpr,dpr); const PAD=24,w=canvas.clientWidth-PAD*2,h=canvas.clientHeight-PAD*2; const min=Math.min(...values),max=Math.max(...values),rng=(max-min)||1; ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1; ctx.strokeRect(PAD,PAD,w,h); ctx.strokeStyle='#2563eb'; ctx.lineWidth=2; ctx.beginPath(); values.forEach((v,i)=>{ const x=PAD+(i/(values.length-1))*w; const y=PAD+(1-((v-min)/rng))*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y) }); ctx.stroke(); ctx.fillStyle='#2563eb'; values.forEach((v,i)=>{ const x=PAD+(i/(values.length-1))*w; const y=PAD+(1-((v-min)/rng))*h; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill() }) }
const weightInput=document.getElementById('weightInput'), addWeightBtn=document.getElementById('addWeightBtn'), resetWeightBtn=document.getElementById('resetWeightBtn')
addWeightBtn.addEventListener('click',()=>{ const v=Number(weightInput.value); if(!v){ return toast('Ange en vikt f√∂rst.') } const arr=DB.weights; arr.push({date:new Date().toISOString(),value:v}); DB.weights=arr; weightInput.value=''; renderChart(); renderHome(); updateCoach(); toast('Vikt tillagd!') })
resetWeightBtn.addEventListener('click',()=>{ DB.weights=[]; renderChart(); renderHome(); updateCoach(); toast('Viktdata nollst√§lld (demo).') })

// ======= M√ÖL & COACH =======
const goalKcalInput=document.getElementById('goalKcalInput'), goalWeightInput=document.getElementById('goalWeightInput'), saveGoalsBtn=document.getElementById('saveGoalsBtn')
saveGoalsBtn.addEventListener('click',()=>{ const gk=Number(goalKcalInput.value||0), gw=Number(goalWeightInput.value||0); if(gk>0) DB.goalKcal=gk; if(gw>0) DB.goalWeight=gw; renderHome(); updateCoach(); goalKcalInput.value=''; goalWeightInput.value=''; toast('M√•l sparade!') })
const coachOut=document.getElementById('coachOutput')
function updateCoach(){ const kcal=kcalToday(), goal=DB.goalKcal, w=DB.weights; let note=''; if(kcal===0) note='Ny dag ‚Äì ny chans! Fota f√∂rsta m√•ltiden n√§r du √§ter üêõ'; else if(kcal<goal*0.6) note='Snygg start! Du ligger bra till f√∂r att n√• dagsm√•let. üü¢'; else if(kcal<=goal) note='Bra fart! Du √§r n√§ra dagsm√•let ‚Äì t√§nk protein och gr√∂nt till middag. üí™'; else note='Du passerade m√•let idag ‚Äì helt okej! Drick vatten, ta en promenad, ny dag imorgon. üíô'; if(w.length>=2){ const diff=(w[w.length-2].value-w[w.length-1].value).toFixed(1); if(diff>0) note+=` \nVikten ner ${diff} kg ‚Äì grymt!`; if(diff<0) note+=` \nLite uppg√•ng √§r normalt. Du fixar det!` } coachOut && (coachOut.textContent=note) }
document.getElementById('refreshCoach')?.addEventListener('click', updateCoach)

// ======= KONTO & PWA =======
const emailInput=document.getElementById('emailInput'); document.getElementById('saveEmailBtn')?.addEventListener('click',()=>{ DB.email=emailInput.value||''; toast('E-post sparad (lokalt).') })
function toast(msg){ const el=document.createElement('div'); el.textContent=msg; el.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;opacity:.96;'; document.body.appendChild(el); setTimeout(()=>el.remove(),2000) }
(function init(){ goalKcalEl.textContent=DB.goalKcal; emailInput && (emailInput.value=DB.email); renderHome(); renderMeals(); renderChart(); updateCoach(); document.querySelectorAll('#tabs button').forEach(btn=>btn.classList.remove('active')); document.querySelector('[data-tab="kamera"]').classList.add('active'); Object.entries(views).forEach(([k,el])=> el.classList.toggle('hidden', k!=='kamera')); if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(console.warn) } })();
let deferredPrompt; const banner=document.getElementById('installBanner'), btnInstall=document.getElementById('installBtn'), btnClose=document.getElementById('installClose')
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; banner?.classList.remove('hidden') })
btnInstall?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; banner?.classList.add('hidden') })
btnClose?.addEventListener('click', ()=> banner?.classList.add('hidden'))
</script>
</body>
</html>
