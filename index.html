<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Latmasken ‚Äì Demo (MVP f√∂rsta utkast)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --ring:#93c5fd;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e5e7eb}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .worm{width:28px;height:28px;border-radius:20px;background:linear-gradient(90deg,#a7f3d0,#fde68a,#fecaca);box-shadow:inset 0 0 0 2px #00000010}
    .title{font-weight:800;letter-spacing:.2px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    nav button{appearance:none;border:1px solid #e5e7eb;background:#fff;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    nav button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px #00000010;border:1px solid #e5e7eb}
    .card .pad{padding:16px}
    label{font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.6px}
    input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font:inherit}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#eef2ff;color:#1e3a8a}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:#eef2ff;color:#1e3a8a;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#f1f5f9;border:1px solid #e2e8f0;padding:8px 10px;border-radius:999px}
    .spacer{height:12px}
    .hidden{display:none}
    footer{padding:40px 16px;color:var(--muted);text-align:center}
    .preview{max-width:100%;border-radius:10px;border:1px dashed #cbd5e1}
  </style>
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.webmanifest" />
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="worm" aria-hidden="true"></div>
        <div>
          <div class="title">Latmasken</div>
          <div class="muted" style="font-size:12px">Fotografera din mat ‚Ä¢ F√• pepp ‚Ä¢ F√∂lj din vikt</div>
        </div>
      </div>
      <nav id="tabs">
        <button data-tab="hem">Hem</button>
        <button data-tab="kamera" class="active">Kamera</button>
        <button data-tab="vikt">Vikt</button>
        <button data-tab="medaljer">Medaljer</button>
        <button data-tab="coach">Coach</button>
        <button data-tab="konto" style="margin-left:auto">Konto</button>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:16px">
    <!-- HEM -->
    <section id="view-hem" class="grid hidden">
      <div class="card"><div class="pad">
        <h2>Idag</h2>
        <div class="row">
          <div class="pill"><strong id="todayKcal">0</strong><span class="muted">kcal av</span> <strong id="goalKcal">1800</strong><span class="muted">kcal</span></div>
          <div class="pill"><strong id="streak">0</strong><span class="muted">dagars streak</span></div>
          <span class="badge" id="goalBadge">M√•l: Vikt ‚àí0.0 kg</span>
        </div>
        <div class="spacer"></div>
        <div id="coachBubble" class="card" style="border-radius:12px;background:#f8fafc;border:1px solid #e2e8f0"><div class="pad">
          <strong>Latmasken s√§ger:</strong>
          <div id="coachMsg" class="muted">Hej! S√§tt ett m√•l i Konto och fota din f√∂rsta m√•ltid via Kamera üêõ</div>
        </div></div>
      </div></div>

      <div class="card"><div class="pad">
        <h3>Dagens intag</h3>
        <div id="foodList" class="muted">Inget loggat √§nnu.</div>
      </div></div>
    </section>

    <!-- KAMERA -->
    <section id="view-kamera" class="grid">
      <div class="card"><div class="pad">
        <h2>Fota din mat</h2>
        <p class="muted">Ladda upp ett foto. F√∂r demo anv√§nder vi en enkel AI‚Äëmock som gissar mat & kalorier ‚Äì du kan justera innan du sparar.</p>
        <input type="file" id="photoInput" accept="image/*" capture="environment" />
        <div class="spacer"></div>
        <img id="photoPreview" class="preview hidden" alt="F√∂rhandsvisning" />
        <div class="spacer"></div>
        <div class="row">
          <select id="foodGuess">
            <option value="Pizza|850">üçï Pizza (~850 kcal)</option>
            <option value="Kycklingsallad|420">ü•ó Kycklingsallad (~420 kcal)</option>
            <option value="Sushi 8 bitar|600">üç£ Sushi 8 bitar (~600 kcal)</option>
            <option value="Pasta carbonara|950">üçù Pasta carbonara (~950 kcal)</option>
            <option value="Havregrynsgr√∂t|320">ü•£ Havregrynsgr√∂t (~320 kcal)</option>
            <option value="Eget val|0">‚úçÔ∏è Eget val‚Ä¶</option>
          </select>
          <input id="foodName" placeholder="Matr√§tt" />
          <input id="foodKcal" type="number" placeholder="kcal" />
          <button class="btn" id="analyzeBtn">Analysera (mock)</button>
          <button class="btn secondary" id="saveMealBtn">Spara</button>
        </div>
      </div></div>

      <div class="card"><div class="pad">
        <h3>Senaste m√•ltider</h3>
        <div id="recentMeals" class="muted">‚Äî</div>
      </div></div>
    </section>

    <!-- VIKT -->
    <section id="view-vikt" class="hidden grid">
      <div class="card"><div class="pad">
        <h2>Viktkurva</h2>
        <canvas id="weightChart" height="220"></canvas>
        <div class="spacer"></div>
        <div class="row">
          <input id="weightInput" type="number" step="0.1" placeholder="Dagens vikt (kg)" />
          <button class="btn" id="addWeightBtn">L√§gg till</button>
          <button class="btn secondary" id="resetWeightBtn">Rensa (demo)</button>
        </div>
      </div></div>

      <div class="card"><div class="pad">
        <h3>M√•l</h3>
        <div class="row">
          <input id="goalKcalInput" type="number" placeholder="Dagligt m√•l (kcal)" />
          <input id="goalWeightInput" type="number" step="0.1" placeholder="M√•lvikt (kg)" />
          <button class="btn" id="saveGoalsBtn">Spara m√•l</button>
        </div>
      </div></div>
    </section>

    <!-- MEDALJER -->
    <section id="view-medaljer" class="hidden grid">
      <div class="card"><div class="pad">
        <h2>Medaljer</h2>
        <ul id="badgeList" class="muted" style="line-height:1.9">
          <li>üèÖ F√∂rsta inloggningen</li>
          <li>üèÖ F√∂rsta m√•ltiden loggad</li>
          <li>üèÖ Tre dagar i rad</li>
          <li>üèÖ F√∂rsta ‚àí1 kg</li>
        </ul>
      </div></div>
    </section>

    <!-- COACH -->
    <section id="view-coach" class="hidden grid">
      <div class="card"><div class="pad">
        <h2>Latmasken coach</h2>
        <p class="muted">I denna demo k√∂r vi en regelbaserad coach. I riktiga systemet byts den mot GPT‚Äëdriven coach med personlig ton.</p>
        <div id="coachOutput" class="card" style="border-radius:12px;background:#f8fafc;border:1px solid #e2e8f0"><div class="pad"></div></div>
        <div class="spacer"></div>
        <button class="btn" id="refreshCoach">Uppdatera coach</button>
      </div></div>
    </section>

    <!-- KONTO -->
    <section id="view-konto" class="hidden grid">
      <div class="card"><div class="pad">
        <h2>Konto</h2>
        <div class="row">
          <input id="emailInput" type="email" placeholder="E‚Äëpost (demo ‚Äì lokal)" />
          <button class="btn" id="saveEmailBtn">Spara</button>
        </div>
        <p class="muted">Demo-l√§ge: vi sparar allt lokalt i din webbl√§sare (localStorage). Inget skickas upp till server.</p>
      </div></div>

      <div class="card"><div class="pad">
        <h3>Datahantering</h3>
        <div class="row">
          <button class="btn secondary" id="resetAllBtn">Rensa all demodata</button>
        </div>
      </div></div>
    </section>
  
  <!-- Installationsbanner (PWA) -->
  <div id="installBanner" class="card hidden" style="position:fixed;left:16px;right:16px;bottom:16px;z-index:999;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px #00000022">
    <div class="pad" style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div class="row" style="gap:12px">
        <div class="worm" aria-hidden="true"></div>
        <div>
          <strong>Installera Latmasken?</strong>
          <div class="muted" style="font-size:12px">L√§gg till p√• hemsk√§rmen f√∂r app-k√§nsla</div>
        </div>
      </div>
      <div class="row" style="gap:8px">
        <button id="installBtn" class="btn">Installera</button>
        <button id="installClose" class="btn secondary">Inte nu</button>
      </div>
    </div>
  </div>

  <footer>
    <div>Latmasken ‚Ä¢ Demo (MVP) ‚Ä¢ ¬© 2025</div>
  </footer>

<script>
// ======= LOKAL LAGRING =======
const DB = {
  get email(){ return localStorage.getItem('email') || '' },
  set email(v){ localStorage.setItem('email', v) },
  get goalKcal(){ return +(localStorage.getItem('goalKcal')||1800) },
  set goalKcal(v){ localStorage.setItem('goalKcal', v) },
  get goalWeight(){ return +(localStorage.getItem('goalWeight')||0) },
  set goalWeight(v){ localStorage.setItem('goalWeight', v) },
  get meals(){ return JSON.parse(localStorage.getItem('meals')||'[]') },
  set meals(arr){ localStorage.setItem('meals', JSON.stringify(arr)) },
  get weights(){ return JSON.parse(localStorage.getItem('weights')||'[]') },
  set weights(arr){ localStorage.setItem('weights', JSON.stringify(arr)) },
  reset(){ localStorage.clear() }
}

// ======= NAVIGATION =======
const tabs = document.querySelectorAll('#tabs button');
const views = {
  hem: document.getElementById('view-hem'),
  kamera: document.getElementById('view-kamera'),
  vikt: document.getElementById('view-vikt'),
  medaljer: document.getElementById('view-medaljer'),
  coach: document.getElementById('view-coach'),
  konto: document.getElementById('view-konto'),
}

tabs.forEach(btn=>btn.addEventListener('click',()=>{
  tabs.forEach(b=>b.classList.remove('active'))
  btn.classList.add('active')
  const target = btn.dataset.tab
  Object.entries(views).forEach(([k,el])=>{
    el.classList.toggle('hidden', k!==target)
  })
  if(target==='vikt') renderChart()
  if(target==='hem' || target==='coach') updateCoach()
  if(target==='hem') renderHome()
  if(target==='kamera') renderMeals()
}))

// ======= HEM / DAGENS INTAG =======
const todayKcalEl = document.getElementById('todayKcal')
const goalKcalEl = document.getElementById('goalKcal')
const foodListEl = document.getElementById('foodList')
const goalBadge = document.getElementById('goalBadge')

function kcalToday(){
  const today = new Date().toISOString().slice(0,10)
  return DB.meals.filter(m=>m.date.startsWith(today)).reduce((s,m)=>s+Number(m.kcal||0),0)
}
function streakDays(){
  // enkel streak: antal dagar i rad med minst en inloggad m√•ltid
  let days = 0
  for(let i=0;i<30;i++){
    const d = new Date(); d.setDate(d.getDate()-i)
    const key = d.toISOString().slice(0,10)
    const has = DB.meals.some(m=>m.date.startsWith(key))
    if(has) days++; else break
  }
  return days
}
function renderHome(){
  goalKcalEl.textContent = DB.goalKcal
  todayKcalEl.textContent = kcalToday()
  document.getElementById('streak').textContent = streakDays()
  // lista dagens m√•ltider
  const today = new Date().toISOString().slice(0,10)
  const items = DB.meals.filter(m=>m.date.startsWith(today))
  if(items.length===0){ foodListEl.textContent = 'Inget loggat √§nnu.'; }
  else {
    foodListEl.innerHTML = items.map(m=>`‚Ä¢ ${m.name} ‚Äì <strong>${m.kcal}</strong> kcal`).join('<br>')
  }
  // m√•lbadge
  const w = DB.weights
  if(w.length>0 && DB.goalWeight>0){
    const start = w[0].value, now = w[w.length-1].value
    const diff = (start-now).toFixed(1)
    goalBadge.textContent = `M√•l: Vikt ${diff} kg / m√•lvikt ${DB.goalWeight} kg`
  } else {
    goalBadge.textContent = 'S√§tt din m√•lvikt under Vikt > M√•l'
  }
}

// ======= KAMERA / M√ÖLTIDER =======
const photoInput = document.getElementById('photoInput')
const photoPreview = document.getElementById('photoPreview')
const foodGuess = document.getElementById('foodGuess')
const foodName = document.getElementById('foodName')
const foodKcal = document.getElementById('foodKcal')
const analyzeBtn = document.getElementById('analyzeBtn')
const saveMealBtn = document.getElementById('saveMealBtn')
const recentMeals = document.getElementById('recentMeals')

photoInput.addEventListener('change', ev=>{
  const f = ev.target.files?.[0]
  if(!f){ photoPreview.classList.add('hidden'); return }
  const url = URL.createObjectURL(f)
  photoPreview.src = url
  photoPreview.classList.remove('hidden')
})

foodGuess.addEventListener('change', ()=>{
  const [name,k] = foodGuess.value.split('|')
  if(name==='Eget val'){ foodName.value=''; foodKcal.value=''; return }
  foodName.value = name
  foodKcal.value = k
})

analyzeBtn.addEventListener('click', ()=>{
  // enkel mock: om inget valt, v√§lj slump fr√•n listan
  if(!foodName.value || !foodKcal.value){
    const opts = ['Pizza|850','Kycklingsallad|420','Sushi 8 bitar|600','Pasta carbonara|950','Havregrynsgr√∂t|320']
    const pick = opts[Math.floor(Math.random()*opts.length)].split('|')
    foodName.value = pick[0]
    foodKcal.value = pick[1]
  }
  toast(`AI (mock): ${foodName.value} ~ ${foodKcal.value} kcal`)
})

saveMealBtn.addEventListener('click', ()=>{
  const name = foodName.value?.trim(); const kcal = Number(foodKcal.value||0)
  if(!name || !kcal){ return toast('Fyll i matr√§tt och kcal f√∂rst.')} 
  const items = DB.meals
  items.push({ name, kcal, date: new Date().toISOString() })
  DB.meals = items
  foodName.value=''; foodKcal.value=''; photoInput.value=''; photoPreview.classList.add('hidden')
  renderMeals(); renderHome(); updateCoach();
  toast('M√•ltid sparad!')
})

function renderMeals(){
  const items = DB.meals.slice(-10).reverse()
  if(items.length===0){ recentMeals.textContent = '‚Äî'; return }
  recentMeals.innerHTML = items.map(m=>{
    const t = new Date(m.date).toLocaleString('sv-SE')
    return `${t}: <strong>${m.name}</strong> ‚Äì ${m.kcal} kcal`
  }).join('<br>')
}

// ======= VIKT / CHART (mini offline-graf, ingen extern lib) =======
let chart
function renderChart(){
  const canvas = document.getElementById('weightChart')
  if(!canvas) return
  const ctx = canvas.getContext('2d')
  const data = DB.weights
  // Rensa
  ctx.clearRect(0,0,canvas.width,canvas.height)
  // Om ingen data ‚Äì visa hint
  if(!data || data.length===0){
    ctx.fillStyle = '#94a3b8';
    ctx.font = '14px Inter, sans-serif';
    ctx.fillText('L√§gg till din f√∂rsta vikt f√∂r att se grafen', 10, 24)
    return
  }
  const values = data.map(d=>Number(d.value))
  const labels = data.map(d=>new Date(d.date))
  const W = canvas.width, H = canvas.height
  # Skala f√∂r pixel-density
  dpr = window.devicePixelRatio or 1
  canvas.width = canvas.clientWidth * dpr
  canvas.height = canvas.clientHeight * dpr
  ctx.scale(dpr,dpr)
  const PAD = 24
  const w = canvas.clientWidth - PAD*2
  const h = canvas.clientHeight - PAD*2
  const min = Math.min(...values)
  const max = Math.max(...values)
  const rng = (max-min)||1
  # Bakgrundsram
  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1
  ctx.strokeRect(PAD, PAD, w, h)
  # Linjegraf
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2
  ctx.beginPath()
  values.forEach((v,i)=>{
    const x = PAD + (i/(values.length-1))*w
    const y = PAD + (1-((v-min)/rng))*h
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)
  })
  ctx.stroke()
  # Punkter
  ctx.fillStyle = '#2563eb'
  values.forEach((v,i)=>{
    const x = PAD + (i/(values.length-1))*w
    const y = PAD + (1-((v-min)/rng))*h
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill()
  })
}

const weightInput = document.getElementById('weightInput')
const addWeightBtn = document.getElementById('addWeightBtn')
const resetWeightBtn = document.getElementById('resetWeightBtn')

addWeightBtn.addEventListener('click',()=>{
  const v = Number(weightInput.value)
  if(!v){ return toast('Ange en vikt f√∂rst.') }
  const arr = DB.weights; arr.push({ date:new Date().toISOString(), value:v }); DB.weights = arr
  weightInput.value=''; renderChart(); renderHome(); updateCoach(); toast('Vikt tillagd!')
})
resetWeightBtn.addEventListener('click',()=>{ DB.weights = []; renderChart(); renderHome(); updateCoach(); toast('Viktdata nollst√§lld (demo).') })

// M√ÖL
const goalKcalInput = document.getElementById('goalKcalInput')
const goalWeightInput = document.getElementById('goalWeightInput')
const saveGoalsBtn = document.getElementById('saveGoalsBtn')

saveGoalsBtn.addEventListener('click',()=>{
  const gk = Number(goalKcalInput.value||0)
  const gw = Number(goalWeightInput.value||0)
  if(gk>0) DB.goalKcal = gk
  if(gw>0) DB.goalWeight = gw
  renderHome(); updateCoach(); goalKcalInput.value=''; goalWeightInput.value=''; toast('M√•l sparade!')
})

// ======= COACH (regelbaserad demo) =======
const coachOut = document.querySelector('#coachOutput .pad')
const coachMsg = document.getElementById('coachMsg')
const refreshCoach = document.getElementById('refreshCoach')

function updateCoach(){
  const kcal = kcalToday(); const goal = DB.goalKcal
  const w = DB.weights; let note = ''
  if(kcal===0){ note = 'Ny dag ‚Äì ny chans! Fota f√∂rsta m√•ltiden n√§r du √§ter üêõ'; }
  else if(kcal < goal*0.6){ note = 'Snygg start! Du ligger bra till f√∂r att n√• dagsm√•let. üü¢'; }
  else if(kcal <= goal){ note = 'Bra fart! Du √§r n√§ra dagsm√•let ‚Äì t√§nk protein och gr√∂nt till middag. üí™'; }
  else { note = 'Du passerade m√•let idag ‚Äì helt okej! Drick vatten, ta en promenad, ny dag imorgon. üíô'; }
  if(w.length>=2){
    const diff = (w[w.length-2].value - w[w.length-1].value).toFixed(1)
    if(diff>0){ note += ` 
Vikten ner ${diff} kg ‚Äì grymt!` }
    if(diff<0){ note += ` 
Lite uppg√•ng √§r normalt. Du fixar det!` }
  }
  (coachMsg||coachOut).textContent = note
  coachOut.textContent = note
}
refreshCoach.addEventListener('click', updateCoach)

// ======= KONTO =======
const emailInput = document.getElementById('emailInput')
const saveEmailBtn = document.getElementById('saveEmailBtn')
const resetAllBtn = document.getElementById('resetAllBtn')

saveEmailBtn.addEventListener('click',()=>{ DB.email = emailInput.value||''; toast('E‚Äëpost sparad (lokalt).') })
resetAllBtn.addEventListener('click',()=>{ if(confirm('Rensa all demodata?')){ DB.reset(); location.reload() } })

// ======= UI HELPERS =======
function toast(msg){
  const el = document.createElement('div')
  el.textContent = msg
  el.style.cssText = 'position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;opacity:.96;'
  document.body.appendChild(el)
  setTimeout(()=>el.remove(), 2000)
}

// INIT
(function init(){
  goalKcalEl.textContent = DB.goalKcal
  emailInput.value = DB.email
  renderHome(); renderMeals(); renderChart(); updateCoach();
  // Starta p√• Kamera (d√∂ljer √∂vriga sektioner)
  document.querySelectorAll('#tabs button').forEach(btn => btn.classList.remove('active'))
  document.querySelector('[data-tab="kamera"]').classList.add('active')
  Object.entries(views).forEach(([k, el]) => el.classList.toggle('hidden', k !== 'kamera'))

  // Registrera service worker (kr√§ver https eller localhost)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').catch(console.warn)
  }
})();

// ======= PWA INSTALL =======
let deferredPrompt
const banner = document.getElementById('installBanner')
const btnInstall = document.getElementById('installBtn')
const btnClose = document.getElementById('installClose')

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e; banner.classList.remove('hidden')
})
btnInstall?.addEventListener('click', async ()=>{
  if(!deferredPrompt) return
  deferredPrompt.prompt()
  const { outcome } = await deferredPrompt.userChoice
  deferredPrompt = null
  banner.classList.add('hidden')
})
btnClose?.addEventListener('click', ()=> banner.classList.add('hidden'))
</script>
</body>
</html>
